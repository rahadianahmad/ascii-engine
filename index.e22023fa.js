!function(){class b{constructor(b,t){this.x=b,this.y=t}add(b){return this.x+=b.x,this.y+=b.y,this}clone(){return new b(this.x,this.y)}static add(b,t){return b.clone().add(t)}static Zero(){return new b(0,0)}}const t=1.13333,e=(b,e)=>{const w=b.layer,s=document.createElement("div");return s.classList.add("game-layer"),s.style.fontSize=`${e}px`,s.style.top=w.pos.y*e+"px",s.style.left=w.pos.x*e*t+"px",s.style.height=w.size.y*e+"px",s.style.width=w.size.x*e*t+"px",s.style.zIndex=b.z.toString(),s},w=b=>{const t=document.createElement("div");return t.classList.add("game-tile"),t.id=`game-${b}`,t};class s{layers={};sortedLayers=[];layerEls={};fontSize=30;constructor(b){this.elemContainer=document.getElementById(b)}addLayer(b,t){if(!(b in this.layers))return this.layers[b]=t,this.sortedLayers.push(t),this.orderLayers(),this}orderLayers(){this.sortedLayers=this.sortedLayers.sort(((b,t)=>b.z-t.z))}clear(){return this.layers={},this.sortedLayers=[],this}commit(){for(let[b,s]of Object.entries(this.layers)){let r=this.layerEls[b];r||(r=e(s,this.fontSize),this.elemContainer.appendChild(r),this.layerEls[b]=r);for(let b of s.layer.drawOps){let e=document.getElementById(`game-${b.tile.id}`);e||(e=w(b.tile.id),r.appendChild(e)),b.isVisible?(e.innerHTML=b.char.replace(/ /g,"&nbsp;"),e.style.color=b.color.cssColor(),e.style.backgroundColor=b.background.cssColor(),e.style.top=b.pos.y*this.fontSize+"px",e.style.left=b.pos.x*this.fontSize*t+"px",e.style.width=this.fontSize*t+"px",e.style.textAlign="center",e.style.display="block",b.orientation>0?e.style.transform=`rotate(${b.orientation}deg)`:e.style.transform="none"):e.style.display="none"}s.layer.clear()}}static MakeLayer(b,t){return{z:b,layer:t}}}class r{drawOps=[];constructor(t){this.opacity=t.opacity||1,this.pos=t.pos||b.Zero(),this.size=t.size,this.isVisible=t.isVisible||!0}draw(b){this.drawOps.push((b=>({tile:b,char:b.char,color:b.color.clone(),background:b.background.clone(),pos:b.pos.clone(),isVisible:b.isVisible,orientation:b.orientation}))(b))}clear(){this.drawOps=[]}}class i{constructor(b,t,e,w){this._r=b,this._g=t,this._b=e,this._a=w,this.makeCssColor()}get r(){return this._r}get g(){return this._g}get b(){return this._b}get a(){return this._a}set r(b){this._r=b,this.makeCssColor()}set g(b){this._g=b,this.makeCssColor()}set b(b){this._b=b,this.makeCssColor()}set a(b){this._a=b,this.makeCssColor()}makeCssColor(){this._cssColor=`rgba(${this._r}, ${this._g}, ${this._b}, ${this._a})`}cssColor(){return this._cssColor}clone(){return new i(this._r,this._g,this._b,this._a)}static Transparent(){return new i(0,0,0,0)}static White(b=1){return new i(255,255,255,b)}static Black(b=1){return new i(0,0,0,b)}static Red(b=1){return new i(255,0,0,b)}static Green(b=1){return new i(0,255,0,b)}static Blue(b=1){return new i(0,0,255,b)}}class n{id=(()=>Math.random().toString(36).slice(2))();orientation_map={up:0,down:180,left:270,right:90};constructor(t){this.char=t.char||" ",this.color=t.color||i.White(),this.background=t.background||i.Black(),this.pos=t.pos||b.Zero(),this.isVisible=t.isVisible||!0,this.orientation=t.orientation||0}orient(b){this.getOrientationForDirection?this.orientation=this.getOrientationForDirection(b):this.orientation=this.orientation_map[b]||0}}const o=(t,e)=>{const w=t%e,s=Math.floor(t/e);return new b(w,s)},a="ArrowUp",h="ArrowDown",l="ArrowLeft",c="ArrowRight";class d{constructor(b,t){if(this.player=b,this.onPlayerNewPosition=t,!this.onPlayerNewPosition)throw new Error("need player new position callback");if(!this.player)throw new Error("need player")}respond(t){const e=Date.now();if(this.last_move){if(e-this.last_move<=100)return}let w,s="up";switch(this.last_move=e,t){case a:w=b.add(this.player.pos,new b(0,-1));break;case h:w=b.add(this.player.pos,new b(0,1)),s="down";break;case l:w=b.add(this.player.pos,new b(-1,0)),s="left";break;case c:w=b.add(this.player.pos,new b(1,0)),s="right"}if(!w)return;this.player.orient(s);this.onPlayerNewPosition(w,this.player)&&(this.player.pos=w)}}class p{charset="+=|æœ¨é—®å‡¶å›žå›šè‚Žçˆª~";constructor(b){b&&(this.charset=b)}check(b,t){const e=this.charset.indexOf(b)>=0,w=this.charset.indexOf(t)>=0;return e||w}}const u=b=>{if("w"===b)return i.White();if("b"===b)return i.Black();if("r"===b)return i.Red();if("g"===b)return i.Green();if("b"===b)return i.Blue();const t=b.split("/");return new i(parseInt(t[0]),parseInt(t[1]),parseInt(t[2]),parseFloat(t[3]))};const y=new b(20,20),g=new n({char:"ðŸ˜€",color:i.Red()});g.getOrientationForDirection=b=>{switch(b){case"up":return 180;case"down":return 0;case"left":return 90;case"right":return 270}return 0};const _=JSON.parse('{"name":"simple house","player_pos":{"x":8,"y":7},"background_chars":[" "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," ","æœ¨"," "," "," "," "," "," "," "," "," "," "," "," "," "," ","æœ¨"," "," "," "," "," "," "," "," "," "," ","+","=","=","=","+"," "," "," "," "," "," "," "," "," "," "," "," "," "," "," ","|","çˆª"," ","é—®","|"," "," "," "," "," "," "," "," "," "," "," "," "," "," ","+","=","=","/","=","+"," "," "," "," "," "," "," "," "," "," "," "," "," "," ","|","å‡¶"," "," ","è‚Ž","|"," "," "," "," "," "," "," "," "," "," "," "," ","æœ¨"," ","å›š"," "," "," "," ","|"," "," "," "," "," "," "," "," "," "," "," "," "," "," ","|","å›ž"," "," "," ","|"," "," "," ","æœ¨"," "," "," "," "," "," "," "," "," "," ","+","=","=","/","=","+"," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," ","~"," "," "," ","æœ¨"," "," "," "," "," "," "," "," "," "," "," "," "," "," "," ","~","~"," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," ","~","~"," "," "," "," "," "," "," "," "," "," ","æœ¨"," "," "," "," "," "," "," ","~","~","~"," "," "," "," "," "," "," "," "," "," "," "," "," "," ","æœ¨"," "," ","~","~","~","~","~"," "," "," "," "," "," "," "," "," "," "," "," "," "," "," ","~","~","~","~","~","~","~"," "," "," "," "," "," "," "," "," "," "," "," "," ","~","~","~","~","~","~","~"," "," "," "," "," "," "," "," "," "," "," "," "," ","~","~","~","~","~","~","~","~"," "," "," "," "," "," "," "," "," "," "," "," ","~","~","~","~","~","~","~","~","~"," "," "," "," "," "," "," "," "," "," "," "],"background_colors":["w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","100/255/100/1","w","w","w","w","w","w","w","w","w","w","w","w","w","w","100/255/100/1","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","131/189/227/1","w","131/189/227/1","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","10/189/227/1","w","w","255/159/67/1","w","w","w","w","w","w","w","w","w","w","w","w","w","100/255/100/1","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","131/149/167/1","w","w","w","w","w","w","w","100/255/100/1","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","0/100/255/1","w","w","w","100/255/100/1","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","0/100/255/1","0/100/255/1","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","0/100/255/1","0/100/255/1","w","w","w","w","w","w","w","w","w","w","100/255/100/1","w","w","w","w","w","w","w","0/100/255/1","0/100/255/1","0/100/255/1","w","w","w","w","w","w","w","w","w","w","w","w","w","w","100/255/100/1","w","w","0/100/255/1","0/100/255/1","0/100/255/1","0/100/255/1","0/100/255/1","w","w","w","w","w","w","w","w","w","w","w","w","w","w","w","0/100/255/1","0/100/255/1","0/100/255/1","0/100/255/1","0/100/255/1","0/100/255/1","0/100/255/1","w","w","w","w","w","w","w","w","w","w","w","w","w","0/100/255/1","0/100/255/1","0/100/255/1","0/100/255/1","0/100/255/1","0/100/255/1","0/100/255/1","w","w","w","w","w","w","w","w","w","w","w","w","w","0/100/255/1","0/100/255/1","0/100/255/1","0/100/255/1","0/100/255/1","0/100/255/1","0/100/255/1","0/100/255/1","w","w","w","w","w","w","w","w","w","w","w","w","0/100/255/1","0/100/255/1","0/100/255/1","0/100/255/1","0/100/255/1","0/100/255/1","0/100/255/1","0/100/255/1","0/100/255/1","w","w","w","w","w","w","w","w","w","w","w"],"background_bg_colors":["b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b"]}');_.player=g;const k=new s("game"),f=new class{background_tiles=[];event_tiles=[];running=!1;constructor(b){this.renderer=b.renderer,this.data=b.data,this.size=b.size,this.input_responders=[],this.data.player&&this.input_responders.push(new d(this.data.player,this.playerNewPosition.bind(this))),this.collision_detector=new p,this.prepare()}prepare(){console.log("scene prepare",this),this.background_layer=new r({size:this.size.clone()});for(let b=0;b<this.data.background_chars.length;b++){const t=this.data.background_chars[b];this.background_tiles.push(new n({char:t,pos:o(b,this.size.x),color:u(this.data.background_colors[b]),background:u(this.data.background_bg_colors[b])}))}this.data.player&&(this.data.player.pos=new b(this.data.player_pos.x,this.data.player_pos.y),this.event_tiles.push(this.data.player)),this.event_layer=new r({size:this.size.clone()})}run(b){if(this.running)throw new Error(`scene ${this.data.name} already running`);this.running=!0,this.input_handler=b,this.input_handler.responders=this.input_responders,this.renderer.clear().addLayer("background",s.MakeLayer(0,this.background_layer)).addLayer("events",s.MakeLayer(1,this.event_layer)),this.drawLoop()}stop(){this.running=!1}drawLoop(){this.running&&(this.background_tiles.forEach((b=>this.background_layer.draw(b))),this.event_tiles.forEach((b=>this.event_layer.draw(b))),this.renderer.commit(),requestAnimationFrame((()=>{this.drawLoop()})))}findBackgroundTile(b){const t=this.size.x*b.y+b.x;return this.background_tiles[t]}playerNewPosition(b,t){const e=this.findBackgroundTile(b);return!e||!this.collision_detector.check(e.char,t.char)}}({data:_,renderer:k,size:y.clone()}),m=new class{responders=[];constructor(){this.setup()}setup(){document.addEventListener("keydown",this.handle.bind(this))}handle(b){this.responders&&this.responders.forEach((t=>{t.respond(b.key)}))}};f.run(m)}();
//# sourceMappingURL=index.e22023fa.js.map
